 <input type='hidden' id='node_id' value=<%= @node_id %> >

 <div class="row svgrow">

        <svg  version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="00 000 10000 1000">
            
        </svg>
</div>



<% content_for :javascript do %>
  <script type="text/javascript">


    $( document ).ready(function() {
      init()

    });

    function init() {
      var node_id = $('#node_id').val();
      node_id = parseInt(node_id)
      get_node_data(node_id);
    }

    var g=null;

    function get_node_data(node_id) {
      $.get('/node_data/' + node_id, function(results){
              var data = results.nodes
              //console.log('reuslts ' + JSON.stringify(data) )

              // clean up the ui 
              $(".tipsy").remove(); // tips
              d3.selectAll("svg > *").remove() // the graph

              // Create a new directed graph
              g = new dagreD3.graphlib.Graph().setGraph({});
      

              generate_nodes(g, data, node_id)
              generate_links2(g, data, results.edges, results.uniq_nodes, results.node_ids)
          

              // Create the renderer
              var render = new dagreD3.render();

              // Set up an SVG group so that we can translate the final graph.
              var svg = d3.select("svg"),
                  inner = svg.append("g");

              // Set up zoom support
              var zoom = d3.zoom()
                  .on("zoom", function() {
                    inner.attr("transform", d3.event.transform);
                  });
              svg.call(zoom);


              // Simple function to style the tooltip for the given node.

              var styleTooltip = function(name, description) {
                return "<p class='name'>" + name + "</p><p class='description'>Account Type: " + description + "</p>";
              };


              // Run the renderer. This is what draws the final graph.
              render(inner, g);

              inner.selectAll("g.node")
                .attr("title", function(v) { return styleTooltip(v, g.node(v).description) })
                .each(function(v) { $(this).tipsy({ gravity: "w", opacity: 1, html: true }); });

              
              inner.selectAll("g.node").on("click", function(d,i) {
                  console.log("on click account id: " + d + ' ' + i); 
                  get_node_data( parseInt(d) )
              });

              // Center the graph
              var initialScale = 0.70;
              svg.call(zoom.transform, d3.zoomIdentity.translate((svg.attr("width") - g.graph().width * initialScale) / 2, 20).scale(initialScale));

              svg.attr('height', g.graph().height * initialScale + 40);
                
              
            })
      }
    
    function generate_nodes(g, nodes, node_id) {
      var states = {}
      for (var i =0; i < nodes.length; i++) {
        var node = nodes[i]
        //onsole.log( JSON.stringify(node))
        states[ node.account_id ] = {  description: node.account_type, style: "fill: " + get_fill_color( node.account_type )}

        if (node_id === node.account_id) {
          states[ node.account_id ] = {  description: node.parent_id, style: "stroke-width:6px; fill: " + get_fill_color( node.account_type )}
        }
      }

      // Add states to the graph, set labels, and style
      Object.keys(states).forEach(function(state) {
        var value = states[state];
        value.label = state;
        value.rx = value.ry = 5;
        g.setNode(state, value);
      });

    }

    function generate_links2(g, nodes, edges, uniq_node_ids, node_ids) {
      //console.log('uniq_node_ids: ' + uniq_node_ids)
      //console.log('node_ids: ' + node_ids)
      
      for (var i =0; i < nodes.length; i++) {
          var node = nodes[i]
          //if ([22936,22932,22934,22935,22937,22938,22939,22940,22942,22943].includes(node.account_id)) {
          if (node_ids.includes(node.account_id) && node_ids.includes(node.parent_id)) {
            //console.log('edge: ' + JSON.stringify(node) )
           g.setEdge( node.parent_id, node.account_id, {})
          }
      } 
         
    }
    

function get_fill_color(node_type)
{
  switch(node_type) {
    case 1: return 'red' 
    case 2: return 'yellow' 
    case 3: return 'green'
    case 4: return 'white'
    case 5: return 'pink'
    case 6: return 'orange'
    case 7: return 'lightgreen'
    case 8: return 'lightblue'
    case 9: return 'salmon'
    case 10: return 'lightpurple'
  }
  
}
  </script>
<% end %>